---
import ContactSidebar from "@/pages/sections/ContactSidebar.astro";
import config from "@/config/config";

interface Props {
    isFixed?: boolean;
    messageContact?: string | null;
}

const { isFixed = true, messageContact = null } = Astro.props;
---

<header
    class="absolute top-0 w-full z-50 soda-header"
>
    <!-- Efecto de burbujas/espuma -->
    <div class="bubbles-container">
        <div class="bubble bubble-1"></div>
        <div class="bubble bubble-2"></div>
        <div class="bubble bubble-3"></div>
        <div class="bubble bubble-4"></div>
        <div class="bubble bubble-5"></div>
        <div class="bubble bubble-6"></div>
        <div class="bubble bubble-7"></div>
        <div class="bubble bubble-8"></div>
    </div>
    
    <div
        class="container mx-auto py-4 flex justify-between items-center px-4 md:px-24 lg:px-24 xl:px-4 relative z-10"
    >
        <div class="flex items-center space-x-4">
            <a href="/" class="cursor-pointer">
                <img
                    src="/logos/logo-color-fondo.png"
                    alt="Talca Logo"
                    class="h-12 lg:h-14"
                />
            </a>
        </div>

        <nav class="hidden xl:block">
            <ul class="flex flex-row items-center text-lg font-bold">
                <li>
                    <a
                        href="/"
                        class="nav-link transition-all duration-300 relative group px-6"
                    >
                        Inicio
                        <div
                            class="bubble-animation absolute -bottom-2 left-0 right-0"
                        >
                        </div>
                    </a>
                </li>
                <li class="text-white/50">|</li>
                <li>
                    <a
                        href="#productos"
                        class="nav-link transition-all duration-300 relative group px-6"
                    >
                        Productos
                        <div
                            class="bubble-animation absolute -bottom-2 left-0 right-0"
                        >
                        </div>
                    </a>
                </li>
                <li class="text-white/50">|</li>
                <li>
                    <a
                        href="#nosotros"
                        class="nav-link transition-all duration-300 relative group px-6"
                    >
                        Nosotros
                        <div
                            class="bubble-animation absolute -bottom-2 left-0 right-0"
                        >
                        </div>
                    </a>
                </li>
                <li class="text-white/50">|</li>
                <li class="relative nav-item">
                    <button
                        id="contactButton"
                        aria-label="Abrir formulario de contacto"
                        class="nav-link transition-all duration-300 relative group px-6"
                    >
                        Contacto
                        <div
                            class="bubble-animation absolute -bottom-2 left-0 right-0"
                        >
                        </div>
                    </button>
                </li>
            </ul>
        </nav>

        <!-- Botón hamburguesa para móvil -->
        <button class="xl:hidden text-white" id="menuButton" aria-label="Menu">
            <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>

        <!-- Menú móvil -->
        <div
            id="mobileMenu"
            class="hidden fixed inset-0 bg-black/90 xl:hidden h-screen"
        >
            <div
                class="flex flex-col items-center justify-center h-full relative"
            >
                <button
                    class="absolute top-8 right-8"
                    id="closeButton"
                    arial-label="Cerrar menú"
                >
                    <svg
                        class="w-8 h-8 text-white"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                <div class="mb-12">
                    <img
                        src="/logos/logo-color-fondo.png"
                        alt="Talca Logo"
                        class="h-16 mb-4"
                    />
                </div>
                <ul
                    class="flex flex-col items-center space-y-6 text-xl font-light"
                >
                    <li class="menu-item group">
                        <a
                            href="/"
                            class="nav-link hover:text-blue transition-all duration-300 relative group"
                        >
                            Inicio
                            <div
                                class="underline-animation h-0.5 bg-primary absolute -bottom-2 left-0 right-0"
                            >
                            </div>
                        </a>
                    </li>
                    <li class="menu-item group">
                        <a
                            href="#productos"
                            class="nav-link hover:text-blue transition-all duration-300 relative group"
                        >
                            Productos
                            <div
                                class="underline-animation h-0.5 bg-primary absolute -bottom-2 left-0 right-0"
                            >
                            </div>
                        </a>
                    </li>
                    <li class="menu-item group">
                        <a
                            href="#nosotros"
                            class="nav-link hover:text-blue transition-all duration-300 relative group"
                        >
                            Nosotros
                            <div
                                class="underline-animation h-0.5 bg-primary absolute -bottom-2 left-0 right-0"
                            >
                            </div>
                        </a>
                    </li>
                    <li class="menu-item">
                        <button
                            id="mobileContactButton"
                            aria-label="Abrir formulario de contacto"
                            class="nav-link hover:text-blue transition-all duration-300 relative group"
                        >
                            Contacto
                            <div
                                class="underline-animation h-0.5 bg-primary absolute -bottom-2 left-0 right-0"
                            >
                            </div>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Borde inferior con efecto de espuma -->
    <div class="foam-border"></div>
</header>

<div
    id="contactSidebar"
    class="fixed inset-y-0 right-0 w-full max-w-full lg:max-w-3xl bg-white transform translate-x-full transition-transform duration-300 ease-in-out z-50 overflow-y-auto"
>
    <button
        id="closeSidebar"
        aria-label="Cerrar formulario de contacto"
        class="absolute top-8 right-8 text-gray-800 hover:text-blue"
    >
        <svg
            class="w-8 h-8"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
        >
            <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"></path>
        </svg>
    </button>
    <ContactSidebar messageContact={messageContact} />
</div>

<!-- overlay -->
<div
    id="sidebarOverlay"
    class="fixed inset-0 bg-black/50 opacity-0 pointer-events-none transition-opacity duration-300 ease-in-out z-40"
>
</div>

<style define:vars={{ primaryColor: config.theme_color }}>
    /* Estilos base para el header */
    .soda-header {
        background: linear-gradient(to bottom, rgba(225, 37, 27, 0.85) 0%, rgba(225, 37, 27, 0.8) 100%);
        color: white;
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(2px);
    }
    
    /* Efecto de espuma en el borde inferior */
    .foam-border {
        height: 8px;
        background: linear-gradient(90deg, 
            rgba(255,255,255,0.9) 0%, 
            rgba(255,255,255,0.6) 20%, 
            rgba(255,255,255,0.9) 40%, 
            rgba(255,255,255,0.5) 60%, 
            rgba(255,255,255,0.8) 80%, 
            rgba(255,255,255,0.7) 100%);
        position: absolute;
        bottom: 0;
        width: 100%;
        border-radius: 50% 50% 0 0 / 100% 100% 0 0;
        filter: blur(1px);
    }
    
    /* Contenedor de burbujas */
    .bubbles-container {
        position: absolute;
        width: 100%;
        height: 100%;
        overflow: hidden;
        top: 0;
        left: 0;
    }
    
    /* Burbujas individuales */
    .bubble {
        position: absolute;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        animation: bubble-rise 8s infinite ease-in;
        bottom: -20px;
    }
    
    .bubble-1 {
        width: 15px;
        height: 15px;
        left: 10%;
        animation-duration: 6s;
        animation-delay: 0.2s;
    }
    
    .bubble-2 {
        width: 10px;
        height: 10px;
        left: 20%;
        animation-duration: 5s;
        animation-delay: 1s;
    }
    
    .bubble-3 {
        width: 8px;
        height: 8px;
        left: 30%;
        animation-duration: 7s;
        animation-delay: 0.5s;
    }
    
    .bubble-4 {
        width: 12px;
        height: 12px;
        left: 40%;
        animation-duration: 6.5s;
        animation-delay: 0.8s;
    }
    
    .bubble-5 {
        width: 9px;
        height: 9px;
        left: 60%;
        animation-duration: 5.5s;
        animation-delay: 0.3s;
    }
    
    .bubble-6 {
        width: 14px;
        height: 14px;
        left: 70%;
        animation-duration: 7.5s;
        animation-delay: 1.2s;
    }
    
    .bubble-7 {
        width: 11px;
        height: 11px;
        left: 80%;
        animation-duration: 6s;
        animation-delay: 0.7s;
    }
    
    .bubble-8 {
        width: 13px;
        height: 13px;
        left: 90%;
        animation-duration: 8s;
        animation-delay: 0.4s;
    }
    
    @keyframes bubble-rise {
        0% {
            transform: translateY(0) scale(1);
            opacity: 0.2;
        }
        50% {
            transform: translateY(-50px) scale(1.1);
            opacity: 0.6;
        }
        100% {
            transform: translateY(-100px) scale(0.8);
            opacity: 0;
        }
    }
    
    /* Estilo para los enlaces de navegación */
    .nav-link {
        color: white;
        font-weight: 600;
        position: relative;
        transition: all 0.3s ease;
    }
    
    .nav-link:hover {
        color: #0439AC;
    }
    
    /* Animación de burbujas en hover */
    .bubble-animation {
        height: 3px;
        width: 0;
        background: white;
        position: absolute;
        bottom: -5px;
        left: 50%;
        transform: translateX(-50%);
        transition: width 0.3s ease;
        border-radius: 3px;
    }
    
    .nav-link:hover .bubble-animation {
        width: 70%;
        animation: bubble-pop 0.5s ease;
        background: #0439AC;
    }
    
    @keyframes bubble-pop {
        0% {
            transform: translateX(-50%) scale(0.5);
            opacity: 0.5;
        }
        50% {
            transform: translateX(-50%) scale(1.2);
            opacity: 0.8;
        }
        100% {
            transform: translateX(-50%) scale(1);
            opacity: 1;
        }
    }
    
    /* Resto de los estilos existentes */
    .menu-enter {
        animation: menuEnter 0.4s ease forwards;
    }
    
    .menu-exit {
        animation: menuExit 0.4s ease forwards;
    }

    .underline-animation {
        width: 0;
        opacity: 0;
        transition:
            width 0.8s ease-out,
            opacity 0.3s ease-out;
    }

    .nav-link:hover .underline-animation {
        width: 100%;
        opacity: 1;
    }

    .nav-link:hover {
        color: #0439AC;
    }

    .underline-animation {
        background-color: #0439AC;
    }

    .menu-item {
        opacity: 0;
        transform: translateY(20px);
    }

    .menu-enter .menu-item {
        animation: menuItemEnter 0.4s ease forwards;
    }

    @keyframes menuEnter {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes menuExit {
        from {
            opacity: 1;
            transform: translateY(0);
        }
        to {
            opacity: 0;
            transform: translateY(-10px);
        }
    }

    @keyframes menuItemEnter {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Estilos para la barra de desplazamiento */
    #contactSidebar::-webkit-scrollbar {
        width: 3px;
    }

    #contactSidebar::-webkit-scrollbar-track {
        background: transparent;
    }

    #contactSidebar::-webkit-scrollbar-thumb {
        background: #e26128;
        border-radius: 3px;
    }

    #contactSidebar::-webkit-scrollbar-thumb:hover {
        background: #c04d1f;
    }
</style>

<script>
import { openSidebar } from "@/utils/helpers";

    const menuButton = document.getElementById(
        "menuButton",
    ) as HTMLButtonElement;
    const closeButton = document.getElementById(
        "closeButton",
    ) as HTMLButtonElement;
    const mobileMenu = document.getElementById("mobileMenu") as HTMLDivElement;
    const mobileLinks = document.querySelectorAll(
        "#mobileMenu a",
    ) as NodeListOf<HTMLAnchorElement>;

    menuButton?.addEventListener("click", () => {
        mobileMenu?.classList.remove("hidden");
        mobileMenu?.classList.add("menu-enter");
        document.body.style.overflow = "hidden";

        const menuItems = document.querySelectorAll(
            ".menu-item",
        ) as NodeListOf<HTMLLIElement>;
        menuItems.forEach((item, index) => {
            item.style.animationDelay = `${0.1 + index * 0.1}s`;
        });
    });

    const closeMenu = () => {
        mobileMenu?.classList.add("menu-exit");
        setTimeout(() => {
            mobileMenu?.classList.add("hidden");
            mobileMenu?.classList.remove("menu-enter", "menu-exit");
        }, 300);
        document.body.style.overflow = "";
    };

    closeButton?.addEventListener("click", closeMenu);
    mobileLinks.forEach((link) => {
        link.addEventListener("click", closeMenu);
    });

    //test de logica de scroll smooth
    const anchors = document.querySelectorAll(
        'a[href^="#"], a[href="/"]',
    ) as NodeListOf<HTMLAnchorElement>;

    anchors.forEach((anchor) => {
        anchor.addEventListener("click", function (e) {
            const href = this.getAttribute("href");

            if (href?.startsWith("#")) {
                e.preventDefault();
                const targetElement = document.querySelector(href);
                if (targetElement) {
                    targetElement.scrollIntoView({
                        behavior: "smooth",
                        block: "start",
                        inline: "nearest",
                    });
                }
            } else if (href === "/" && window.location.pathname === "/") {
                e.preventDefault();
                window.scrollTo({
                    top: 0,
                    behavior: "smooth",
                });
            }
        });
    });

    const contactButton = document.getElementById("contactButton");
    const mobileContactButton = document.getElementById("mobileContactButton");
    const contactSidebar = document.getElementById("contactSidebar");
    const sidebarOverlay = document.getElementById("sidebarOverlay");

    const closeSidebarHandler = () => {
        contactSidebar?.classList.add("translate-x-full");
        sidebarOverlay?.classList.add("opacity-0", "pointer-events-none");
        document.body.style.overflow = "";
    };

    contactButton?.addEventListener("click", openSidebar);
    mobileContactButton?.addEventListener("click", openSidebar);
    document
        .getElementById("closeSidebarBtn")
        ?.addEventListener("click", closeSidebarHandler);
    sidebarOverlay?.addEventListener("click", closeSidebarHandler);
</script>
